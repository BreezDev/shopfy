<section
  class="section section--{{ section.settings.section_width }} customizable-builder"
  style="{% render 'spacing-style', settings: section.settings %}"
>
  {% if section.settings.heading != blank %}
    <div class="builder-heading">
      <h2 class="h3">{{ section.settings.heading }}</h2>
      {% if section.settings.subheading != blank %}
        <p class="subheading">{{ section.settings.subheading }}</p>
      {% endif %}
    </div>
  {% endif %}

  <div class="builder-grid" style="--builder-columns: {{ section.settings.columns }}; --builder-gap: {{ section.settings.gap }}px;">
    {% for block in section.blocks %}
      <div class="builder-card" {{ block.shopify_attributes }}>
        {% case block.type %}
          {% when 'text' %}
            {% render 'text', block: block %}
          {% when 'image' %}
            {% render 'image', image: block.settings.image, class: 'builder-image', text_fallback: block.settings.alt_text %}
          {% when 'video' %}
            {% render 'video', video: block.settings.video, autoplay: block.settings.autoplay, loop: block.settings.loop, muted: true %}
          {% when 'button' %}
            <a href="{{ block.settings.link }}" class="button button--primary">
              {{ block.settings.label }}
            </a>
          {% when 'carousel' %}
            {% assign slides = block.settings.slides | newline_to_br | split: '<br />' %}
            <div
              class="builder-carousel"
              role="list"
              aria-label="Carousel content"
              data-auto-rotate="{{ block.settings.auto_rotate }}"
              data-interval="{{ block.settings.interval | times: 1000 }}"
            >
              {% for slide in slides %}
                <div class="builder-carousel__slide" role="listitem">
                  {{ slide | strip_html | escape }}
                </div>
              {% endfor %}
              {% if block.settings.controls %}
                <div class="builder-carousel__controls">
                  <button class="button button-unstyled" type="button" data-carousel-prev aria-label="Previous">{{ 'icon-chevron-left.svg' | inline_asset_content }}</button>
                  <button class="button button-unstyled" type="button" data-carousel-next aria-label="Next">{{ 'icon-chevron-right.svg' | inline_asset_content }}</button>
                </div>
              {% endif %}
            </div>
          {% when 'liquid' %}
            <div class="custom-liquid rte">
              {{ block.settings.custom_liquid }}
            </div>
          {% when 'spacer' %}
            <div style="height: {{ block.settings.height }}px"></div>
        {% endcase %}
      </div>
    {% endfor %}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.builder-carousel').forEach((carousel) => {
      const slides = Array.from(carousel.querySelectorAll('.builder-carousel__slide'));
      if (slides.length === 0) return;

      let index = 0;
      const intervalMs = Number(carousel.dataset.interval) || 5000;
      const autoRotate = carousel.dataset.autoRotate === 'true';
      let timer;

      const showSlide = (newIndex) => {
        index = (newIndex + slides.length) % slides.length;
        slides.forEach((slide, i) => {
          slide.style.display = i === index ? 'block' : 'none';
        });
      };

      const start = () => {
        if (!autoRotate) return;
        clearInterval(timer);
        timer = setInterval(() => showSlide(index + 1), intervalMs);
      };

      carousel.querySelector('[data-carousel-prev]')?.addEventListener('click', () => {
        showSlide(index - 1);
        start();
      });

      carousel.querySelector('[data-carousel-next]')?.addEventListener('click', () => {
        showSlide(index + 1);
        start();
      });

      showSlide(index);
      start();
    });
  });
</script>

{% schema %}
{
  "name": "Custom content builder",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build your story"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Stack images, videos, carousels, buttons, and more."
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "default": "page-width",
      "options": [
        { "value": "page-width", "label": "Page" },
        { "value": "full-width", "label": "Full" }
      ]
    },
    {
      "type": "range",
      "id": "columns",
      "label": "Columns",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Grid gap",
      "min": 0,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 24
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 32
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 32
    }
  ],
  "blocks": [
    {
      "type": "text",
      "name": "Text",
      "settings": [
        { "type": "richtext", "id": "text", "label": "Text", "default": "<p>Add your copy here.</p>" },
        { "type": "select", "id": "width", "label": "Width", "options": [ {"value": "fit-content", "label": "Fit"}, {"value": "100%", "label": "Fill"} ], "default": "100%" },
        { "type": "select", "id": "max_width", "label": "Max width", "options": [ {"value": "narrow", "label": "Narrow"}, {"value": "normal", "label": "Normal"}, {"value": "none", "label": "None"} ], "default": "normal" },
        { "type": "text_alignment", "id": "alignment", "label": "Alignment", "default": "left" },
        { "type": "select", "id": "type_preset", "label": "Preset", "options": [ {"value": "rte", "label": "Rich text"}, {"value": "heading", "label": "Heading"}, {"value": "paragraph", "label": "Paragraph"} ], "default": "rte" }
      ]
    },
    {
      "type": "image",
      "name": "Image",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "alt_text", "label": "Alt text" }
      ]
    },
    {
      "type": "video",
      "name": "Video",
      "settings": [
        { "type": "video_picker", "id": "video", "label": "Video" },
        { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": false },
        { "type": "checkbox", "id": "loop", "label": "Loop", "default": false }
      ]
    },
    {
      "type": "carousel",
      "name": "Carousel",
      "settings": [
        { "type": "textarea", "id": "slides", "label": "Slides (one per line)", "default": "Slide one\nSlide two" },
        { "type": "select", "id": "icons_style", "label": "Icons", "options": [ {"value": "arrows", "label": "Arrows"}, {"value": "dots", "label": "Dots"} ], "default": "arrows" },
        { "type": "checkbox", "id": "controls", "label": "Show controls", "default": true },
        { "type": "checkbox", "id": "auto_rotate", "label": "Auto rotate", "default": false },
        { "type": "range", "id": "interval", "label": "Interval (s)", "min": 3, "max": 12, "step": 1, "default": 5 }
      ]
    },
    {
      "type": "button",
      "name": "Button",
      "settings": [
        { "type": "text", "id": "label", "label": "Label", "default": "Learn more" },
        { "type": "url", "id": "link", "label": "Link" }
      ]
    },
    {
      "type": "liquid",
      "name": "Custom liquid",
      "settings": [
        { "type": "liquid", "id": "custom_liquid", "label": "Liquid/HTML" }
      ]
    },
    {
      "type": "spacer",
      "name": "Spacer",
      "settings": [
        { "type": "range", "id": "height", "label": "Height", "min": 0, "max": 120, "step": 4, "unit": "px", "default": 24 }
      ]
    }
  ],
  "max_blocks": 24,
  "presets": [
    {
      "name": "Custom content builder",
      "blocks": [
        { "type": "text" },
        { "type": "image" },
        { "type": "button" }
      ]
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .customizable-builder {
    display: grid;
    gap: var(--builder-gap);
  }

  .builder-heading {
    display: grid;
    gap: 8px;
    margin-bottom: 12px;
  }

  .builder-grid {
    display: grid;
    grid-template-columns: repeat(var(--builder-columns), minmax(0, 1fr));
    gap: var(--builder-gap);
  }

  .builder-card {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--style-border-radius-cards);
    padding: var(--padding-md);
    box-shadow: var(--shadow-card);
  }

  .builder-image {
    width: 100%;
    height: auto;
    display: block;
    border-radius: var(--style-border-radius-cards);
  }

  .builder-carousel {
    position: relative;
    display: grid;
    gap: 12px;
  }

  .builder-carousel__slide {
    padding: var(--padding-sm);
    border-radius: var(--style-border-radius-cards);
    background: rgba(255, 255, 255, 0.06);
  }

  .builder-carousel__controls {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  .subheading {
    color: rgb(var(--color-foreground-rgb) / 0.75);
  }

  @media screen and (max-width: 749px) {
    .builder-grid {
      grid-template-columns: 1fr;
    }
  }
{% endstylesheet %}
